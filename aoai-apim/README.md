# Azure OpenAI common foundation with Azure API Management

Azure OpenAIの共通基盤を自動構築するサンプルコードです。

![アーキテクチャ](.\assets\architecture.png)

組織全体でガバナンスを効かせたうえでAzure OpenAIの利活用を促進するためには、次の要件を満たす共通基盤を用意し、利用者へ公開する取り組みが必要になります。

| No | 項目 | 要件 |
|:-:|:-----|:-|
| 1 | 認証・認可 | Microsoft Entra ID(旧称Azure Active Directory)を活用した認証方式に統一し、認可したアプリやユーザーのみAzure OpenAIの利用を許可する |
| 2 | 課金 | Azure OpenAIを利用した分だけ部門や利用者ごとに課金請求できるようにする |
| 3 | 流量制限 | 特定の部門やチームがクォータ制限を消費し尽くさないようにするため、部門や利用者単位でリクエスト数を制限する |
| 4 | ログ統合 | Azure OpenAI利用時のプロンプトや生成結果の出力先を一ヵ所に統合する |
| 5 | 閉域化 | 多層防御の観点からプライベートネットワークに閉じた形でAzure OpenAIを利用できるようにする |
| 6 | 負荷分散 | Azure OpenAIは同一のサブスクリプションかつリージョン内で処理可能なTPM(トークン/分)が制限として決まっており、クォータ制限の引き上げ申請には時間がかかる場合がある。よりすばやく、柔軟に対応できるようにするためには複数リージョンで負荷分散を行い利用可能なTPMを増やせるよう検討する必要がある |

本サンプルコードでは、これらの要件を満たす一例となるアーキテクチャを自動構築していきます。

# 事前準備

1. Microsoft Entra IDへアプリの登録
    * Azure OpenAI APIを呼び出すアプリケーションをMicrosoft Entra IDに登録します。この操作を行うためにはMicrosoft Entra ID のアプリケーションを管理するための権限が必要です。次のMicrosoft Entra IDロールには、いずれも必要な権限が含まれています。
        * アプリケーション管理者
        * アプリケーション開発者
        * クラウドアプリケーション管理者
    * それでは、次の手順でアプリの登録を行います。
        1. [Azure portal](https://portal.azure.com/)上部ので、［アプリの登録］を検索して選択
        2. ［新規登録］を選択
        3. ［アプリケーションの登録］ページが表示されたら、以下のアプリケーションの登録情報を入力
            * ［名前］：任意のアプリケーション名を指定してください。とくに指定したい名称がない場合はcommon-openai-apiを指定してください
            * ［ サポートされているアカウントの種類］：シナリオに適したオプションを選択してください。とくに選択したいオプションがない場合は、［この組織ディレクトリのみに含まれるアカウント］を選択してください
            * ［リダイレクト URI］：リダイレクトさせたいアプリケーションのURIがある場合はここに入力してください。のちほど行うアーキテクチャの解説ではサンプルのPythonコードを使用して実際にAzure OpenAI APIを呼び出します。サンプルのPythonコードを使用する方はWebのプラットフォームを選択し、URIにはhttp://localhost:5000/callback を指定してください。リダイレクトURIは、あとで使用するためメモしてください
            <img width="600" src=".\assets\regist-aoai-app.png">
        4. ［登録］を選択して、アプリケーションを作成
            * アプリの［概要］ページに表示されている［アプリケーション（クライアント）ID］の値をあとで用いるためメモしてください
            <img width="600" src=".\assets\application-id.png">
        5. サイドメニューの［管理］セクションで［APIの公開］を選択し、［スコープの追加］ボタンを選択
        6. ［アプリケーションIDのURI］は、変更せず［保存してから続ける］ボタンを選択
            * ［スコープ名］APIによって保護されているデータと機能に対するアクセスを制限するためのスコープを定義します。今回は例として「chat」を指定します
            <img width="300" src=".\assets\add-scope.png">
            * ［同意できるのはだれですか?］ユーザーも同意できるようにするため、［管理者とユーザ］を選択します
            * 管理者やユーザーの同意の表示名や説明は任意の値を指定してください
            * ［状態］有効になっていることを確認してください
        7. ［スコープの追加］ボタンを選択して、スコープを作成
            * 追加されたスコープの値（例：api://<登録アプリID>/chat）をあとで用いるためメモしてください。値の右のボタンでコピーできます
            <img width="600" src=".\assets\copy-scope.png">

2. デプロイするユーザーへの権限付与         
    * デプロイするユーザーのMicrosoft Entra IDアカウントに対し、デプロイ先のサブスクリプションに対して所有者権限を付与してください。

# デプロイ

1. サンプルコードのダウンロード
    * サンプルコードをまだダウンロードしていない場合は、git cloneでダウンロードしてから所定のディレクトリへ移動してください。サンプルコードのライセンスはMIT License です。PowerShellやBash/Zshを起動して以下のコマンドを実行します。
        ```
        git clone -b https://github.com/shohei1029/book-azureopenai-sample.git
        cd book-azureopenai-sample/aoai-apim
        ```
2. パラメータの設定
    * デプロイに必要なパラメータはすべてaoai-apim/infra/main.parameters.json に集約されています。main.parameters.jsonの内容を次の表のように編集してください。   

| パラメータ名 | 投入する値 | 値の例 |
|:-|:-|:-|
| environmentName | デプロイ時に指定するため編集不要 |  |
| location | デプロイ時に指定するため編集不要 |  |
| aoaiFirstLocation | デプロイするAzure OpenAI モデルのファーストリージョンを指定 | japaneastなど |
| aoaiSecondLocation | デプロイするAzure OpenAI モデルのセカンドリージョンを指定 | eastusなど |
| corsOriginUrl | 認証を行うシングルページアプリ（SPA）のドメインを指定。ドメインが確定していない場合、デフォルトの「*」を指定することもできるが、確定しだい具体的なドメインを指定するのが推奨 | *、example.com、yourapp.azurewebsites.netなど |
| audienceAppId | 登録したアプリの概要に記載されている［アプリケーション（クライアント）ID］ | bcd1234-abcd-1234-abcd-1234abcd1234 |
| scopeName | スコープ名 | chat |
| tenantId | Microsoft Entra IDの概要に記載されている［テナント ID］ | abcd1234-abcd-1234-abcd-1234abcd1234 |
| aoaiCapacity | デプロイするモデルのTPM（トークン/分）の制限を指定。ここで設定した数値は×1,000される（10と設定されていた場合、1分間に10,000トークンまで処理できるという意味合い） | 1、10、100 など |

3. Azure Developer CLIのログイン
    * 以下のコマンドを用いて、デプロイする対象となるサブスクリプションの属するMicrosoft Entra IDテナントにログインします。
        ```
        azd auth login
        ```
    * ブラウザのない環境の場合は--use-device-code、テナントを明示的に指定したい場合には--tenant-idを追加で指定してください。

4. デプロイの実行
    * 以下のコマンドを実行します。
        ```
        azd up
        ```
    * 以下の内容を聞かれるのでそれぞれ設定します。
        * 環境名：任意の環境名を指定。rg-<環境名>というリソースグループが作成される
        * サブスクリプションの選択：リソースグループを作成するサブスクリプションを選択
        * ロケーションの選択：Japan EastなどAzure OpenAIを除くその他のAzureサービスをデプロイするリージョンを指定
    * デプロイの完了までに20〜30 分ほど要します。指定した環境名などは.azureディレクトリ配下に保存されているため、再度指定は不要です。環境を再定義し、ゼロから作成しなおしたい場合には.azureディレクトリを削除などしてください。